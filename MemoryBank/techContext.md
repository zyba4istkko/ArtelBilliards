# Технический контекст Artel Billiards

## Технические особенности

1. **Платформа**: Telegram Mini Apps как основная платформа
2. **Режим работы**: Только онлайн, без офлайн-режима
3. **Система событий**:
   - Забитые шары с указанием типа и дополнительной информации
   - Штрафы и фолы
   - Логирование всех действий
4. **Функции для повышения удобства**:
   - Таймер для отслеживания длительности игр
   - Автоматический расчет выигрышей/проигрышей
   - Профили игроков с историей
   - Управление списком друзей

## Технологический стек

### Frontend
- **React 19.1.0** - основная библиотека UI
- **Vite 7.0.4** - сборщик и инструмент разработки
- **React Context API** - управление состоянием
- **Пользовательский CSS** - стилизация
- **Telegram Mini Apps SDK** - интеграция с Telegram

### Backend
- **FastAPI** - веб-фреймворк для Python
- **Python 3.8+** - основной язык бэкенда
- **SQLAlchemy** - ORM для работы с базой данных
- **Alembic** - миграции базы данных
- **Pydantic** - валидация данных
- **Uvicorn** - ASGI сервер
- **RabbitMQ** - брокер сообщений для асинхронных задач
- **fastStream** - фреймворк для работы с RabbitMQ

### База данных
- **PostgreSQL** - основная база данных
- Поддержка реляционных связей для игроков, сессий, игр
- Оптимизация для быстрого доступа к текущим играм

### Интеграция и авторизация
- **JWT tokens** - аутентификация и авторизация
- **Google Auth** - авторизация через Google
- **Telegram API** - авторизация через Telegram
- **WebSockets** - для реал-тайм обновлений

### Тестирование
- **pytest** - основной фреймворк для тестирования
- **pytest-asyncio** - тестирование асинхронного кода
- **pytest-cov** - покрытие кода тестами
- **Factory Boy** - создание тестовых данных

### Мониторинг и логирование
- **Prometheus** - сбор метрик и мониторинг
- **Grafana** - визуализация метрик (рекомендуется)
- **Python logging** - структурированное логирование
- **Loguru** - улучшенное логирование (альтернатива)

### Инфраструктура
- **Docker** - контейнеризация приложения
- **Docker Compose** - оркестрация локальной разработки
- **PostgreSQL** - в Docker контейнере
- **RabbitMQ** - в Docker контейнере

## Требования к системе

### Зависимости
- Python 3.8+ для FastAPI бэкенда
- Node.js 18+ для React фронтенда
- Docker & Docker Compose для контейнеризации
- PostgreSQL для базы данных
- RabbitMQ для очередей сообщений
- Основные Python пакеты:
  - fastapi, uvicorn, sqlalchemy, alembic, pydantic
  - faststream, pika (для RabbitMQ)
  - pytest, pytest-asyncio, pytest-cov
  - prometheus-client, loguru
  - python-jose[cryptography] (для JWT)
  - passlib[bcrypt] (для хеширования паролей)

### Производительность
- Быстрое отображение текущего состояния игры
- Минимальная задержка при добавлении событий
- Эффективная синхронизация между клиентами

### Безопасность
- Защищенные API эндпоинты
- Валидация прав доступа к сессиям
- Безопасное хранение пользовательских данных

## Проблемы и решения

- **Проблема**: Синхронизация игры в реальном времени
  **Решение**: Реализация WebSocket соединений для живых обновлений

- **Проблема**: Сложная логика бильярдной игры
  **Решение**: Создание модульного игрового движка с четким управлением состоянием

- **Проблема**: Кроссплатформенная совместимость
  **Решение**: Использование адаптивного дизайна и функций прогрессивного веб-приложения

- **Проблема**: Управление пустыми пользователями
  **Решение**: Создание временных профилей с ограниченными правами

## Архитектура приложения

### Монолитная структура (рекомендуемая для MVP)
- Единое приложение с четким разделением на слои
- Frontend: React приложение в Telegram Mini Apps
- Backend: FastAPI сервер с REST API
- Database: PostgreSQL с оптимизированной схемой

### Коммуникация
- REST API для основных операций
- WebSockets для реал-тайм обновлений
- JSON формат данных
- Стандартные HTTP коды ответов

### Структура проекта
```
artelBilliards/
├── react-app/              # Frontend React приложение
├── fast-api-app/           # Backend FastAPI приложение
│   ├── app/                # Основное приложение
│   ├── tests/              # Тесты (pytest)
│   ├── alembic/            # Миграции базы данных
│   ├── logs/               # Логи приложения
│   └── requirements.txt    # Python зависимости
├── docker/                 # Docker конфигурации
│   ├── Dockerfile.backend  # Dockerfile для backend
│   ├── Dockerfile.frontend # Dockerfile для frontend
│   └── docker-compose.yml  # Оркестрация сервисов
├── monitoring/             # Мониторинг и метрики
│   ├── prometheus.yml      # Конфигурация Prometheus
│   └── grafana/           # Дашборды Grafana
├── docs/                   # Документация проекта
└── .env                   # Переменные окружения
```

## Интеграция новых технологий

### RabbitMQ + fastStream
**Назначение**: Асинхронная обработка задач и межсервисное взаимодействие
**Использование**:
- Отправка уведомлений в Telegram
- Обработка статистики игр в фоновом режиме
- Синхронизация данных между сессиями
- Обработка событий игры в реальном времени

### JWT токены
**Назначение**: Безопасная аутентификация и авторизация
**Использование**:
- Аутентификация пользователей в API
- Управление сессиями пользователей
- Контроль доступа к игровым сессиям
- Интеграция с Telegram Mini Apps

### Alembic
**Назначение**: Управление миграциями базы данных
**Использование**:
- Версионирование схемы базы данных
- Безопасное обновление структуры БД
- Откат изменений при необходимости
- Синхронизация схемы между окружениями

### pytest
**Назначение**: Комплексное тестирование приложения
**Использование**:
- Unit тесты для бизнес-логики
- Integration тесты для API
- Тестирование асинхронных функций
- Покрытие кода тестами

### Логирование (Loguru)
**Назначение**: Структурированное логирование событий
**Использование**:
- Логирование действий пользователей
- Отслеживание ошибок и исключений
- Аудит изменений в играх
- Мониторинг производительности

### Prometheus
**Назначение**: Мониторинг и сбор метрик
**Использование**:
- Метрики производительности API
- Мониторинг использования ресурсов
- Отслеживание количества активных игр
- Алерты при проблемах

### Docker
**Назначение**: Контейнеризация и развертывание
**Использование**:
- Изоляция сервисов приложения
- Упрощение развертывания
- Консистентность окружений
- Масштабирование компонентов
